var map,platform=new H.service.Platform({apikey:"Qmof-OsgXqBI0HKADFFvY74eeVZdq3QoEW2_f2sEUgE"}),router=platform.getRoutingService(null,8),service=platform.getSearchService(),defaultLayers=platform.createDefaultLayers(),co=null,eal=!0,business={name:"",address:{address:"",postcode:""},address_geo:null,suppliers:[],customers:[]};const ids=["name","address","postcode","product","load","co2","usage","delivery"],factor=62/1e3;let bs=localStorage.getItem("bi");console.log(bs),bs&&(business=JSON.parse(bs));var marker=null,selected=null;function updateBusiness(){localStorage.setItem("bi",JSON.stringify(business))}function locateAddress(a){let b=document.getElementById("postcode").value,c=document.getElementById("address"),d=c.value;a.srcElement.disabled=!0,console.log(a);let e={};return d?void(b&&(e.qq="postalCode="+encodeURIComponent(b)),d&&(e.q=d),c.setCustomValidity(""),service.geocode(e,c=>{a.srcElement.disabled=!1,c.items[0]?(marker&&map.removeObject(marker),business.address={address:d,postcode:b},business.address_geo=c.items[0].position,updateBusiness(),marker=new H.map.Marker(business.address_geo),map.addObject(marker),map.setCenter(business.address_geo)):window.alert("Location not found, please try changing the address.")},()=>{a.srcElement.disabled=!1,window.alert("There was a problem accessing geolocation services. Please try again.")})):(c.setCustomValidity("No address provided."),c.reportValidity(),void(a.srcElement.disabled=!1))}function updateName(a){let b=a.srcElement.value;b&&(business.name=b,updateBusiness())}function initialiseFields(){document.getElementById("postcode").value=business.address.postcode,document.getElementById("address").value=business.address.address,document.getElementById("name").value=business.name}function collapse(){document.getElementById("mapContainer").classList.toggle("collapsed"),document.getElementById("panel").classList.toggle("collapsed"),map.getViewPort().resize()}function selectSupply(){document.getElementById("supply").classList.contains("selected")||(document.getElementById("supply").classList.add("selected"),document.getElementById("customer").classList.remove("selected"))}function selectCustomer(){return void alert("Feature not implemented. Sorry :(")}function removeModal(){let a=document.getElementById("modal_supplier"),b=document.getElementById("modal_customer");b.classList.remove("visible"),a.classList.remove("visible"),document.getElementById("blackout").classList.remove("visible")}function add(){let a=document.getElementById("modal_supplier"),b=document.getElementById("modal_customer");if(document.getElementById("customer").classList.contains("selected"))return void alert("Feature not implemented. Sorry :(");a.classList.add("visible"),b.classList.remove("visible"),ids.forEach(a=>document.getElementById(a+"_supplier").value="");selected&&(removeSelected(),document.getElementsByClassName("selected_item")[0].classList.remove("selected_item")),document.getElementById("blackout").classList.add("visible"),co=null}function ltln2str({lat:a,lng:b}){return a+","+b}function detdel(){const a=ids.map(a=>document.getElementById(a+"_supplier").value);return a[1]==co?.address&&a[2]==co?.postcode&&null!=co?.dist?void(document.getElementById("delivery_supplier").value=co.dist*factor):void(co=_.zipObject(ids,a),geo(!1,()=>document.getElementById("delivery_supplier").value=co.delivery))}function geo(a=!0,b=()=>{}){if(co.address_geo){if(a){var c=new H.map.Marker(co.address_geo);map.addObject(c)}return void path(a,b)}service.geocode({q:co.address+" "+co.postcode},c=>{if(!c.items[0])return void alert("Unable to verify the location of the business");if(co.address_geo=c.items[0].position,updateBusiness(),a){var d=new H.map.Marker(co.address_geo);map.addObject(d)}path(a,b)},()=>alert("Unable to verify the location of the business"))}function path(a=!0,b=()=>{}){const c=get_color(co,.6);return co.routes?(a&&co.routes.forEach(a=>{let b=H.geo.LineString.fromFlexiblePolyline(a),d=new H.map.Polyline(b,{style:{strokeColor:c,lineWidth:3}});map.addObject(d)}),void b()):void router.calculateRoute({routingMode:"short",transportMode:"truck",origin:ltln2str(business.address_geo),destination:ltln2str(co.address_geo),return:["polyline","summary"]},d=>{if(d.routes.length){let e=0;co.routes=[],d.routes[0].sections.forEach(b=>{let d=H.geo.LineString.fromFlexiblePolyline(b.polyline);if(co.routes.push(b.polyline),e+=b.summary.length,a){let a=new H.map.Polyline(d,{style:{strokeColor:c,lineWidth:3}});map.addObject(a)}console.log("hi",b)}),co.delivery=e/1e3*factor,co.dist=e/1e3,updateBusiness(),b()}else alert("Cannot calculate route!")},()=>alert("Cannot calculate route!"))}function genSupplier(a){let b=document.createElement("div");b.innerHTML=`<div class='item' onclick='select_item(event)'><div class='itemrow'>
  <div class='itemtitle'>${a.name?a.name:"Untitled Supplier"}</div><div class='itemaddr'>
  ${a.address} ${a.dist?"("+a.dist+"km)":""}</div></div>
  <div class='pad'></div>
  <div class='itemrow center'><div class='itemtitle bold'>
  ${isNaN(get_total(a))?"&#8211":display_unit(get_total(a),"g")}</div>
  <div class='itemaddr'>of CO&#x2082;eq in the whole supply chain.</div>
  <div class='pad'></div>
  <div class='itemtitle bold ts' style='color: ${get_color(a,1)};'>
  ${isNaN(get_score(a))?"&#8211":(100*normalise_score(get_score(a))).toFixed(2)}</div>
  <div class='itemaddr'>Your Supply Chain Score</div></div>
  </div>`;let c=b.children[0];return c.supplier=a,c}function select_item(a){if(selected)selected.classList.remove("selected_item");else for(let a of document.getElementById("brow").children)a.disabled=!1;selected=a.currentTarget,selected.classList.add("selected_item")}function addSupplier(){const a=ids.map(a=>document.getElementById(a+"_supplier").value);(a[1]!=co?.address||a[2]!=co?.postcode)&&(co=null),co?_.assign(co,_.zipObject(ids,a)):co=_.zipObject(ids,a),geo(),selected?(_.assign(selected.supplier,co),selected.innerHTML=genSupplier(selected.supplier).innerHTML):(business.suppliers.push(co),document.getElementById("dinfo").appendChild(genSupplier(co))),updateBusiness(),removeModal()}function removeSelected(){selected=null;let a=document.getElementById("brow").children;a[0].disabled=!0,a[1].disabled=!0}function remove(){_.pull(business.suppliers,selected.supplier),selected.remove(),removeSelected(),updateBusiness()}function edit(){eal&&(alert("Editing will not redraw on the map due to network request constraints."),eal=!1),_s=selected,add();for(let a of document.getElementById("brow").children)a.disabled=!1;selected=_s,selected.classList.add("selected_item"),co=selected.supplier,ids.forEach(a=>document.getElementById(a+"_supplier").value=co[a])}function get_total(a){return empty(a.usage,a.delivery,a.co2)?NaN:+a.usage+ +a.delivery+ +a.co2}function get_score(a){if(empty(a.usage,a.delivery,a.co2))return NaN;const b=+a.usage+ +a.delivery,c=+a.co2+ +a.delivery;return b*c/(b+c)}function normalise_score(a){return isNaN(a)?NaN:Math.max(Math.min(1,1-Math.exp(-Math.pow(a,3/4)/500)),0)}function empty(...a){return a.some(a=>!a)}function get_color(b,c){let a=get_score(b);if(isNaN(a))return"rgba(0, 0, 0, "+c+")";a=normalise_score(a);let d=120*(1-a);return"hsla("+d+", 100%, 47%, "+c+")"}function display_unit(a,b){return 1e3>a?a.toPrecision(3)+b:(a/=1e3,1e3>a?a.toPrecision(3)+"k"+b:a.toFixed(0)+"k"+b)}window.onload=()=>{map=new H.Map(document.getElementById("mapContainer"),defaultLayers.vector.normal.map,{zoom:6.4,center:{lng:-1.0192634415914916,lat:52.95379526429705}}),business.address_geo&&(marker=new H.map.Marker(business.address_geo),map.addObject(marker),map.setCenter(business.address_geo));var a=new H.mapevents.MapEvents(map),b=new H.mapevents.Behavior(a),c=H.ui.UI.createDefault(map,defaultLayers);initialiseFields(),business.suppliers.forEach(a=>{if(co=a,document.getElementById("dinfo").appendChild(genSupplier(a)),a.address_geo){var b=new H.map.Marker(a.address_geo);map.addObject(b),path(!0)}}),co=null};